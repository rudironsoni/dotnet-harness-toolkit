name: Update Distribution Repo

on:
  push:
    branches: [main]
    paths:
      - ".rulesync/**"
      - "rulesync.jsonc"
      - "scripts/build/**"
      - "packages/dotnet-harness-*/**"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (skip PR creation)"
        required: false
        default: "false"
        type: boolean

# Restrict to read-only by default; jobs opt-in as needed
permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-distribution:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout source repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Generate and build bundles
        run: |
          set -euo pipefail
          bash scripts/build/build_plugin_bundles.sh

      - name: Build platform packages
        run: |
          set -euo pipefail
          npm run build:platform-packages

      - name: Get source commit info
        id: source_info
        run: |
          set -euo pipefail
          echo "SHA=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          # Use %s format and env var to avoid shell injection from commit messages
          MSG="$(git log -1 --format='%s')"
          echo "MSG<<EOFMSG" >> "$GITHUB_OUTPUT"
          echo "$MSG" >> "$GITHUB_OUTPUT"
          echo "EOFMSG" >> "$GITHUB_OUTPUT"
          echo "SHA_FULL=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Clone distribution repo
        env:
          DIST_TOKEN: ${{ secrets.DOTNET_HARNESS_TOOLKIT_GH_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${DIST_TOKEN}" ]]; then
            echo "DOTNET_HARNESS_TOOLKIT_GH_TOKEN is required."
            exit 1
          fi

          if ! curl -fsS \
            -H "Authorization: Bearer ${DIST_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/rudironsoni/dotnet-harness-plugin >/dev/null; then
            echo "DOTNET_HARNESS_TOOLKIT_GH_TOKEN cannot access rudironsoni/dotnet-harness-plugin."
            exit 1
          fi

          # Mask the token so it never appears in logs
          echo "::add-mask::${DIST_TOKEN}"
          git clone --recurse-submodules \
            "https://x-access-token:${DIST_TOKEN}@github.com/rudironsoni/dotnet-harness-plugin.git" \
            /tmp/dist-repo

      - name: Update distribution content
        env:
          SOURCE_SHA_FULL: ${{ steps.source_info.outputs.SHA_FULL }}
        run: |
          set -euo pipefail
          DIST="/tmp/dist-repo"

          # ===================================================================
          # PROTECTED (never removed):
          #   .git/  .gitmodules  dotnet-harness/  (submodule)
          #   README.md  LICENSE  .gitignore
          #   .github/workflows/  .github/actions/  (dist-repo CI, if any)
          #
          # MANAGED (removed + replaced each run):
          #   Bundle directories and root files listed below, plus
          #   copilot content inside .github/ (agents, instructions, prompts,
          #   skills, copilot-instructions.md) â€” but NOT .github/workflows/
          #   or .github/actions/.
          # ===================================================================

          # Bundle directories that are fully managed (safe to rm -rf)
          BUNDLE_DIRS=(
            ".claude"
            ".opencode"
            ".codex"
            ".gemini"
            ".agents"
            ".agent"
            "packages"
          )

          # Copilot subdirectories inside .github/ (surgical removal)
          COPILOT_SUBDIRS=(
            "agents"
            "instructions"
            "prompts"
            "skills"
          )
          COPILOT_ROOT_FILES=(
            "copilot-instructions.md"
          )

          # Root files that bundles may include
          BUNDLE_ROOT_FILES=(
            "AGENTS.md"
            "GEMINI.md"
          )

          # 1. Remove managed bundle directories
          for dir in "${BUNDLE_DIRS[@]}"; do
            rm -rf "${DIST}/${dir}"
          done

          # 2. Remove copilot content inside .github/ (preserve workflows/actions)
          for subdir in "${COPILOT_SUBDIRS[@]}"; do
            rm -rf "${DIST}/.github/${subdir}"
          done
          for f in "${COPILOT_ROOT_FILES[@]}"; do
            rm -f "${DIST}/.github/${f}"
          done

          # 3. Remove managed root files
          for f in "${BUNDLE_ROOT_FILES[@]}"; do
            rm -f "${DIST}/${f}"
          done

          # 4. Extract each bundle into the distribution repo
          for zip_file in dist/*.zip; do
            echo "Extracting $(basename "$zip_file")..."
            unzip -o "$zip_file" -d "$DIST"
          done

          # 5. Copy all platform package directories
          mkdir -p "${DIST}/packages"
          for pkg in packages/dotnet-harness-*; do
            if [[ ! -d "${pkg}" ]]; then
              continue
            fi
            pkg_name="$(basename "${pkg}")"
            rm -rf "${DIST}/packages/${pkg_name}"
            mkdir -p "${DIST}/packages/${pkg_name}"

            for f in package.json README.md index.js index.d.ts; do
              if [[ -f "${pkg}/${f}" ]]; then
                cp -r "${pkg}/${f}" "${DIST}/packages/${pkg_name}/"
              fi
            done

            if [[ -d "${pkg}/bundled" ]]; then
              cp -r "${pkg}/bundled" "${DIST}/packages/${pkg_name}/"
            fi
          done

          # 6. Update submodule reference to latest source commit
          git -C "${DIST}" submodule sync --recursive
          git -C "${DIST}" submodule update --init --recursive

          SUBMODULE_PATH="dotnet-harness"
          if [[ ! -d "${DIST}/${SUBMODULE_PATH}" ]]; then
            SUBMODULE_PATH="dotnet-agent-harness"
          fi

          cd "${DIST}/${SUBMODULE_PATH}"
          git fetch --force --prune origin +refs/heads/main:refs/remotes/origin/main
          git fetch --force --prune --unshallow origin || true

          if ! git cat-file -e "${SOURCE_SHA_FULL}^{commit}" 2>/dev/null; then
            git fetch --force --prune origin "${SOURCE_SHA_FULL}" || true
          fi

          if git cat-file -e "${SOURCE_SHA_FULL}^{commit}" 2>/dev/null; then
            git checkout "${SOURCE_SHA_FULL}"
          else
            echo "Warning: could not resolve source commit in submodule: ${SOURCE_SHA_FULL}"
            echo "Falling back to submodule origin/main."
            git checkout origin/main
          fi
          cd "${DIST}"

      - name: Check for changes
        id: changes
        run: |
          set -euo pipefail
          cd /tmp/dist-repo
          git add -A
          if git diff --cached --quiet; then
            echo "HAS_CHANGES=false" >> "$GITHUB_OUTPUT"
            echo "No changes to distribute."
          else
            echo "HAS_CHANGES=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            git diff --cached --stat
          fi

      - name: Create PR on distribution repo
        if: steps.changes.outputs.HAS_CHANGES == 'true' && !inputs.dry_run
        env:
          GH_TOKEN: ${{ secrets.DOTNET_HARNESS_TOOLKIT_GH_TOKEN }}
          SOURCE_SHA: ${{ steps.source_info.outputs.SHA }}
          SOURCE_SHA_FULL: ${{ steps.source_info.outputs.SHA_FULL }}
          SOURCE_MSG: ${{ steps.source_info.outputs.MSG }}
        run: |
          set -euo pipefail
          cd /tmp/dist-repo

          BRANCH="update/source-${SOURCE_SHA}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Handle duplicate branch: if branch already exists on remote, delete it first
          if git ls-remote --exit-code origin "refs/heads/${BRANCH}" >/dev/null 2>&1; then
            echo "Branch ${BRANCH} already exists on remote, deleting..."
            git push origin --delete "${BRANCH}" || true
          fi

          git checkout -b "$BRANCH"
          git commit -m "chore: update plugins from source (${SOURCE_SHA})" \
            -m "Source commit: rudironsoni/dotnet-harness@${SOURCE_SHA_FULL}" \
            -m "Source message: ${SOURCE_MSG}"

          git push origin "$BRANCH"

          # Close any existing PR for this branch before creating a new one
          EXISTING_PR="$(gh pr list \
            --repo "rudironsoni/dotnet-harness-plugin" \
            --head "${BRANCH}" \
            --state open \
            --json number \
            --jq '.[0].number // empty' 2>/dev/null || true)"
          if [[ -n "$EXISTING_PR" ]]; then
            echo "Closing existing PR #${EXISTING_PR}..."
            gh pr close "$EXISTING_PR" --repo "rudironsoni/dotnet-harness-plugin" || true
          fi

          gh pr create \
            --repo "rudironsoni/dotnet-harness-plugin" \
            --base main \
            --head "$BRANCH" \
            --title "chore: update plugins from source (${SOURCE_SHA})" \
            --body "$(cat <<EOF
          ## Plugin Update

          Automated update from source repo [\`dotnet-harness\`](https://github.com/rudironsoni/dotnet-harness).

          **Source commit:** [\`${SOURCE_SHA}\`](https://github.com/rudironsoni/dotnet-harness/commit/${SOURCE_SHA_FULL})
          **Source message:** ${SOURCE_MSG}

          ### What changed
          - Rebuilt all platform bundles (claudecode, opencode, copilot, codexcli, geminicli, agentsmd, antigravity)
          - Updated platform npm packages
          - Updated submodule reference to latest source commit

          ### Preserved
          - Submodule (\`dotnet-harness/\`)
          - Repository metadata (\`README.md\`, \`LICENSE\`, \`.gitignore\`, \`.gitmodules\`)
          EOF
          )"

          echo "PR created successfully."
