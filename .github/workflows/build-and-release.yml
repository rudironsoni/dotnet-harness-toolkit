name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Semver version to release (e.g., v1.0.0)"
        required: true
        default: "v0.0.1"

# Restrict to read-only by default; jobs opt-in as needed
permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # Never cancel an in-progress release

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high

      - name: Validate
        run: npm run ci:rulesync

      - name: Build plugin bundles
        run: bash scripts/build/build_plugin_bundles.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-bundles
          path: dist/*.zip
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: (startsWith(github.ref, 'refs/tags/v') && !contains(github.ref_name, '-')) || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: plugin-bundles
          path: dist/

      - name: Get version
        id: get_version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            VERSION="$INPUT_VERSION"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version must be strict semver in the form vMAJOR.MINOR.PATCH"
            echo "Received: $VERSION"
            exit 1
          fi

          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate descriptive changelog
        id: changelog
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Find previous tag for comparison
          PREVIOUS_TAG=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | grep -v "^${VERSION}$" | head -n1 || true)

          if [[ -n "${PREVIOUS_TAG}" ]]; then
            COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
            COMPARE_URL="https://github.com/${GITHUB_REPOSITORY}/compare/${PREVIOUS_TAG}...${VERSION}"
          else
            COMMIT_RANGE="HEAD"
            COMPARE_URL=""
          fi

          # Function to categorize commits
          categorize_commits() {
            local pattern="${1}"
            git log "${COMMIT_RANGE}" --pretty=format:"%s" --reverse | grep -E "^${pattern}:" || true
          }

          # Function to format commit message
          format_commit() {
            local msg="${1}"
            # Extract the description after the type(scope): prefix
            local desc
            desc=$(echo "${msg}" | sed -E 's/^[a-z]+(\([^)]+\))?:\s*//')
            # Extract scope if present
            local scope
            scope=$(echo "${msg}" | grep -oE '^[a-z]+\(([^)]+)\)' | sed -E 's/^[a-z]+\(([^)]+)\)/\1/' || true)
            
            if [[ -n "${scope}" ]]; then
              echo "- **${scope}**: ${desc}"
            else
              echo "- ${desc}"
            fi
          }

          # Generate changelog
          {
            echo "## What's Changed"
            echo ""
            
            if [[ -n "${COMPARE_URL}" ]]; then
              echo "**Full Changelog**: ${COMPARE_URL}"
              echo ""
            fi
            
            # Features
            FEATS=$(categorize_commits "feat")
            if [[ -n "${FEATS}" ]]; then
              echo "### Features"
              echo "${FEATS}" | while read -r line; do
                format_commit "${line}"
              done
              echo ""
            fi
            
            # Bug Fixes
            FIXES=$(categorize_commits "fix")
            if [[ -n "${FIXES}" ]]; then
              echo "### Bug Fixes"
              echo "${FIXES}" | while read -r line; do
                format_commit "${line}"
              done
              echo ""
            fi
            
            # Performance
            PERFS=$(categorize_commits "perf")
            if [[ -n "${PERFS}" ]]; then
              echo "### Performance Improvements"
              echo "${PERFS}" | while read -r line; do
                format_commit "${line}"
              done
              echo ""
            fi
            
            # Documentation
            DOCS=$(categorize_commits "docs")
            if [[ -n "${DOCS}" ]]; then
              echo "### Documentation"
              echo "${DOCS}" | while read -r line; do
                format_commit "${line}"
              done
              echo ""
            fi
            
            # Refactoring
            REFACTORS=$(categorize_commits "refactor")
            if [[ -n "${REFACTORS}" ]]; then
              echo "### Code Refactoring"
              echo "${REFACTORS}" | while read -r line; do
                format_commit "${line}"
              done
              echo ""
            fi
            
            # Build System
            BUILDS=$(categorize_commits "build")
            if [[ -n "${BUILDS}" ]]; then
              echo "### Build System"
              echo "${BUILDS}" | while read -r line; do
                format_commit "${line}"
              done
              echo ""
            fi
            
            # CI/CD
            CIS=$(categorize_commits "ci")
            if [[ -n "${CIS}" ]]; then
              echo "### CI/CD"
              echo "${CIS}" | while read -r line; do
                format_commit "${line}"
              done
              echo ""
            fi
            
            # Tests
            TESTS=$(categorize_commits "test")
            if [[ -n "${TESTS}" ]]; then
              echo "### Tests"
              echo "${TESTS}" | while read -r line; do
                format_commit "${line}"
              done
              echo ""
            fi
            
            # Other commits (excluding chore and merge)
            OTHERS=$(git log "${COMMIT_RANGE}" --pretty=format:"%s" --reverse | grep -v -E '^(feat|fix|perf|docs|refactor|build|ci|test|chore|Merge|merge):' || true)
            if [[ -n "${OTHERS}" ]]; then
              echo "### Other Changes"
              echo "${OTHERS}" | while read -r line; do
                echo "- ${line}"
              done
              echo ""
            fi
            
            # Contributors
            echo "### Contributors"
            echo ""
            CONTRIBUTORS=$(git log "${COMMIT_RANGE}" --pretty=format:"%an <%ae>" | sort | uniq)
            echo "${CONTRIBUTORS}" | while read -r contributor; do
              if [[ -n "${contributor}" ]]; then
                echo "- ${contributor}"
              fi
            done
            echo ""
            
            echo "---"
            echo ""
            echo "## Plugin Assets"
            echo ""
            echo "This release includes the following plugin bundles:"
            echo ""
            echo "| Plugin | Description |"
            echo "|--------|-------------|"
            echo "| dotnet-harness-claudecode.zip | Claude Code plugin bundle |"
            echo "| dotnet-harness-opencode.zip | OpenCode plugin bundle |"
            echo "| dotnet-harness-copilot.zip | GitHub Copilot plugin bundle |"
            echo "| dotnet-harness-codexcli.zip | Codex CLI plugin bundle |"
            echo "| dotnet-harness-geminicli.zip | Gemini CLI plugin bundle |"
            echo "| dotnet-harness-agentsmd.zip | AGENTS.md plugin bundle |"
            echo "| dotnet-harness-antigravity.zip | Antigravity plugin bundle |"
            echo ""
          } > CHANGELOG.md

          echo "Generated changelog for version ${VERSION}"
          cat CHANGELOG.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body_path: CHANGELOG.md
          files: dist/*.zip
          draft: false
          prerelease: false

  publish-github-packages:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref_name, '-')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          registry-url: "https://npm.pkg.github.com"
          scope: "@rudironsoni"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build platform packages
        run: |
          set -euo pipefail
          npm run build:platform-packages

      - name: Publish to GitHub Packages
        run: |
          set -euo pipefail
          for pkg in packages/dotnet-harness-*; do
            if [[ ! -d "$pkg" ]]; then
              continue
            fi
            if [[ ! -f "$pkg/package.json" ]]; then
              continue
            fi
            echo "Publishing $(basename "$pkg")"
            cd "$pkg"
            npm publish
            cd - >/dev/null
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-distribution-repo:
    needs: build
    runs-on: ubuntu-latest
    if: (startsWith(github.ref, 'refs/tags/v') && !contains(github.ref_name, '-')) || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: plugin-bundles
          path: dist/

      - name: Get version
        id: get_version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            VERSION="$INPUT_VERSION"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version must be strict semver in the form vMAJOR.MINOR.PATCH"
            echo "Received: $VERSION"
            exit 1
          fi

          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Validate distribution token access
        env:
          GH_TOKEN: ${{ secrets.DOTNET_HARNESS_TOOLKIT_GH_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${GH_TOKEN}" ]]; then
            echo "DOTNET_HARNESS_TOOLKIT_GH_TOKEN is required."
            exit 1
          fi

          if ! curl -fsS \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/rudironsoni/dotnet-harness-plugin >/dev/null; then
            echo "DOTNET_HARNESS_TOOLKIT_GH_TOKEN cannot access rudironsoni/dotnet-harness-plugin."
            exit 1
          fi

      - name: Generate descriptive changelog for distribution release
        id: changelog
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          set -euo pipefail

          previous_tag="$(python3 - <<'PY'
          import re
          import os
          import subprocess

          version = os.environ["VERSION"]
          m = re.fullmatch(r"v(\d+)\.(\d+)\.(\d+)", version)
          if not m:
              raise SystemExit(1)
          current = tuple(map(int, m.groups()))

          tags = subprocess.check_output([
              "git", "tag", "--list", "v[0-9]*.[0-9]*.[0-9]*"
          ], text=True).splitlines()

          parsed = []
          for t in tags:
              mm = re.fullmatch(r"v(\d+)\.(\d+)\.(\d+)", t)
              if not mm:
                  continue
              tup = tuple(map(int, mm.groups()))
              if tup < current:
                  parsed.append((tup, t))

          if parsed:
              parsed.sort()
              print(parsed[-1][1])
          PY
          )"
          if [[ -n "$previous_tag" ]]; then
            range="${previous_tag}..HEAD"
            compare_text="Compared against ${previous_tag}."
          else
            range="HEAD"
            compare_text="First release baseline (no previous semver tag found)."
          fi

          changed_files="$(git diff --name-only $range || true)"

          touches_shared=false
          if printf '%s\n' "$changed_files" | grep -Eq '^(\.rulesync/|scripts/build/|\.github/workflows/|package\.json|package-lock\.json|README\.md$)'; then
            touches_shared=true
          fi

          touched() {
            local pattern="$1"
            if [[ "$touches_shared" == true ]]; then
              return 0
            fi
            printf '%s\n' "$changed_files" | grep -Eq "$pattern"
          }

          status_line() {
            local changed="$1"
            if [[ "$changed" == true ]]; then
              printf '%s' "Changed"
            else
              printf '%s' "No direct content change"
            fi
          }

          claudecode=false
          opencode=false
          copilot=false
          codexcli=false
          geminicli=false
          agentsmd=false
          antigravity=false

          touched '^(packages/dotnet-harness-claudecode/|\.rulesync/rules/targets/claudecode\.md)' && claudecode=true || true
          touched '^(packages/dotnet-harness-opencode/|\.rulesync/rules/targets/opencode\.md)' && opencode=true || true
          touched '^(packages/dotnet-harness-copilot/|\.rulesync/rules/targets/copilot\.md|\.github/)' && copilot=true || true
          touched '^(packages/dotnet-harness-codexcli/|\.rulesync/rules/targets/codexcli\.md)' && codexcli=true || true
          touched '^(packages/dotnet-harness-geminicli/|\.rulesync/rules/targets/geminicli\.md)' && geminicli=true || true
          touched '^(packages/dotnet-harness-agentsmd/|\.rulesync/rules/targets/agentsmd\.md)' && agentsmd=true || true
          touched '^(packages/dotnet-harness-antigravity/|\.rulesync/rules/targets/antigravity\.md)' && antigravity=true || true

          cat > dist/release-notes-plugin.md <<EOF
          ## Release Summary

          - Source version: ${VERSION}
          - ${compare_text}
          - This release packages regenerated plugin artifacts from the source-of-truth RuleSync definitions.

          ## Plugin Changelog and Rationale

          ### dotnet-harness-claudecode
          - Status: $(status_line "$claudecode")
          - What changed: Refreshed Claude Code bundle content under \\.claude with latest generated agents, skills, commands, and rules.
          - Rationale: Keep Claude plugin installs aligned with current source guidance and avoid stale local bootstrap content.

          ### dotnet-harness-opencode
          - Status: $(status_line "$opencode")
          - What changed: Rebuilt OpenCode plugin payload and bundled manifests for generated agents, skills, commands, memories, and plugin config.
          - Rationale: Ensure OpenCode consumers get consistent behavior with the latest source changes and package metadata.

          ### dotnet-harness-copilot
          - Status: $(status_line "$copilot")
          - What changed: Updated generated Copilot instructions/prompts/skills/agents artifacts and copilot instruction entrypoint.
          - Rationale: Keep Copilot prompt/instruction surfaces synchronized with source-authored rules and platform capabilities.

          ### dotnet-harness-codexcli
          - Status: $(status_line "$codexcli")
          - What changed: Regenerated Codex CLI bundle and root AGENTS documentation payload for package consumers.
          - Rationale: Preserve compatibility between Codex CLI installs and the canonical multi-agent rule definitions.

          ### dotnet-harness-geminicli
          - Status: $(status_line "$geminicli")
          - What changed: Refreshed Gemini CLI bundle and GEMINI markdown guidance payload.
          - Rationale: Ensure Gemini users receive current operational instructions and generated skill/agent content.

          ### dotnet-harness-agentsmd
          - Status: $(status_line "$agentsmd")
          - What changed: Rebuilt AGENTS.md-focused bundle and associated generated \\.agents assets.
          - Rationale: Keep AGENTS.md consumers aligned with latest source orchestration and role definitions.

          ### dotnet-harness-antigravity
          - Status: $(status_line "$antigravity")
          - What changed: Regenerated Antigravity-compatible bundle under \\.agent.
          - Rationale: Maintain parity for Antigravity installs with source-maintained cross-platform guidance.
          EOF

      - name: Create release in distribution repo
        env:
          GH_TOKEN: ${{ secrets.DOTNET_HARNESS_TOOLKIT_GH_TOKEN }}
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          set -euo pipefail

          if gh release view "$VERSION" --repo rudironsoni/dotnet-harness-plugin >/dev/null 2>&1; then
            gh release upload "$VERSION" dist/*.zip \
              --repo rudironsoni/dotnet-harness-plugin \
              --clobber
            gh release edit "$VERSION" \
              --repo rudironsoni/dotnet-harness-plugin \
              --notes-file dist/release-notes-plugin.md
          else
            gh release create "$VERSION" dist/*.zip \
              --repo rudironsoni/dotnet-harness-plugin \
              --title "Release $VERSION" \
              --notes-file dist/release-notes-plugin.md
          fi

  verify-distribution-release:
    needs:
      - release
      - release-distribution-repo
    runs-on: ubuntu-latest
    if: (startsWith(github.ref, 'refs/tags/v') && !contains(github.ref_name, '-')) || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Resolve version
        id: get_version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            VERSION="$INPUT_VERSION"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version must be strict semver in the form vMAJOR.MINOR.PATCH"
            echo "Received: $VERSION"
            exit 1
          fi

          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Validate source/distribution release alignment
        env:
          GH_TOKEN: ${{ secrets.DOTNET_HARNESS_TOOLKIT_GH_TOKEN }}
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          set -euo pipefail

          src_json="$(gh release view "$VERSION" --repo rudironsoni/dotnet-harness --json tagName,assets)"
          dst_json="$(gh release view "$VERSION" --repo rudironsoni/dotnet-harness-plugin --json tagName,assets,body)"

          src_assets="$(printf '%s' "$src_json" | jq -r '.assets[].name' | sort)"
          dst_assets="$(printf '%s' "$dst_json" | jq -r '.assets[].name' | sort)"

          if [[ "$src_assets" != "$dst_assets" ]]; then
            echo "Source and distribution release assets differ for $VERSION"
            echo "--- source assets ---"
            printf '%s\n' "$src_assets"
            echo "--- distribution assets ---"
            printf '%s\n' "$dst_assets"
            exit 1
          fi

          required_assets=(
            "dotnet-harness-claudecode.zip"
            "dotnet-harness-opencode.zip"
            "dotnet-harness-copilot.zip"
            "dotnet-harness-codexcli.zip"
            "dotnet-harness-geminicli.zip"
            "dotnet-harness-agentsmd.zip"
            "dotnet-harness-antigravity.zip"
          )

          for a in "${required_assets[@]}"; do
            if ! printf '%s\n' "$dst_assets" | grep -Fxq "$a"; then
              echo "Missing required distribution asset: $a"
              exit 1
            fi
          done

          body="$(printf '%s' "$dst_json" | jq -r '.body')"
          required_sections=(
            "## Release Summary"
            "## Plugin Changelog and Rationale"
            "### dotnet-harness-claudecode"
            "### dotnet-harness-opencode"
            "### dotnet-harness-copilot"
            "### dotnet-harness-codexcli"
            "### dotnet-harness-geminicli"
            "### dotnet-harness-agentsmd"
            "### dotnet-harness-antigravity"
          )

          for section in "${required_sections[@]}"; do
            if ! printf '%s\n' "$body" | grep -Fq "$section"; then
              echo "Distribution release notes missing section: $section"
              exit 1
            fi
          done
