name: Tag On PR Merge

on:
  pull_request_target:
    types:
      - closed

permissions: {}

concurrency:
  group: tag-on-pr-merge-main
  cancel-in-progress: false

jobs:
  tag:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout merge commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0

      - name: Create and push next semver tag
        env:
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          set -euo pipefail

          if [[ -z "${MERGE_SHA}" ]]; then
            echo "No merge commit SHA found; skipping tag creation."
            exit 0
          fi

          git fetch --tags --force

          existing_tag="$(git tag --points-at "${MERGE_SHA}" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1 || true)"
          if [[ -n "${existing_tag}" ]]; then
            echo "Merge commit already has semver tag: ${existing_tag}"
            exit 0
          fi

          attempt=1
          max_attempts=5
          while [[ ${attempt} -le ${max_attempts} ]]; do
            latest_tag="$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1 || true)"

            if [[ -z "${latest_tag}" ]]; then
              next_tag="v0.1.0"
            else
              if [[ ! "${latest_tag}" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
                echo "Latest tag is not strict semver: ${latest_tag}"
                exit 1
              fi

              major="${BASH_REMATCH[1]}"
              minor="${BASH_REMATCH[2]}"
              patch="${BASH_REMATCH[3]}"
              next_tag="v${major}.${minor}.$((patch + 1))"
            fi

            if git rev-parse "${next_tag}" >/dev/null 2>&1; then
              echo "Tag ${next_tag} already exists locally/remotely, retrying..."
              git fetch --tags --force
              attempt=$((attempt + 1))
              sleep 1
              continue
            fi

            git tag -a "${next_tag}" "${MERGE_SHA}" -m "Release ${next_tag} from merged PR #${PR_NUMBER}: ${PR_TITLE}"
            if git push origin "${next_tag}"; then
              echo "Created and pushed ${next_tag}"
              exit 0
            fi

            echo "Push failed for ${next_tag}, retrying..."
            git tag -d "${next_tag}" || true
            git fetch --tags --force
            attempt=$((attempt + 1))
            sleep 1
          done

          echo "Failed to create unique semver tag after ${max_attempts} attempts"
          exit 1
