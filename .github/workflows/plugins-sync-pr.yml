name: Sync Plugins On PR

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: plugins-sync-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  sync-plugins:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR head branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.DOTNET_HARNESS_TOOLKIT_GH_TOKEN || github.token }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Regenerate full plugin bundles
        run: bash scripts/build/build_plugin_bundles.sh

      - name: Validate generated bundles
        run: bash scripts/ci/validate_bundles.sh

      - name: Smoke install and runtime checks
        run: bash scripts/ci/smoke_install.sh

      - name: Detect plugin changes
        id: plugin_changes
        run: |
          if git diff --quiet -- plugins; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Commit regenerated plugins to PR branch
        if: steps.plugin_changes.outputs.changed == 'true' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          git add plugins
          GIT_AUTHOR_NAME="github-actions[bot]" \
          GIT_AUTHOR_EMAIL="41898282+github-actions[bot]@users.noreply.github.com" \
          GIT_COMMITTER_NAME="github-actions[bot]" \
          GIT_COMMITTER_EMAIL="41898282+github-actions[bot]@users.noreply.github.com" \
          git commit -m "chore(plugins): regenerate bundles [ci-generated-plugins]"
          git push origin "HEAD:${{ github.event.pull_request.head.ref }}"

      - name: Fail fork PR and request maintainer sync
        if: steps.plugin_changes.outputs.changed == 'true' && github.event.pull_request.head.repo.full_name != github.repository
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --body "Plugin bundles are generated by CI and this fork PR needs maintainer sync.\n\nMaintainer action: run the \`Sync Plugins For PR\` workflow with PR number \`${{ github.event.pull_request.number }}\`." || true

          echo "Fork PR cannot be updated automatically with generated plugins."
          echo "Maintainer must run: Actions -> Sync Plugins For PR -> PR #${{ github.event.pull_request.number }}"
          exit 1
