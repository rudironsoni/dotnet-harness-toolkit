name: Release Plugin Bundles

on:
  push:
    branches: ["main"]
    paths:
      - "rulesync.jsonc"
      - ".rulesync/**"
      - ".github/actions/**"
      - "scripts/**"
      - "plugins/**"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/rulesync-validate.yml"
      - ".github/workflows/rulesync-generate.yml"
      - ".github/workflows/plugins-sync-pr.yml"
      - ".github/workflows/sync-plugins-for-pr.yml"

concurrency:
  group: plugins-release-main
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Validate RuleSync generation
        run: bash scripts/ci/validate_rulesync.sh

      - name: Build plugin and manual bundles
        run: bash scripts/build/build_plugin_bundles.sh --output-dir .tmp/plugins

      - name: Validate generated bundles
        uses: ./.github/actions/validate-plugin-bundles
        with:
          plugins-dir: .tmp/plugins

      - name: Smoke install and runtime checks
        uses: ./.github/actions/smoke-install
        with:
          plugins-dir: .tmp/plugins

      - name: Verify committed plugins are up to date
        run: |
          if ! diff -qr plugins .tmp/plugins >/dev/null; then
            echo "Committed plugins/* is stale compared to generated output."
            echo "Regenerate with: bash scripts/build/build_plugin_bundles.sh"
            diff -qr plugins .tmp/plugins || true
            exit 1
          fi

      - name: Determine release tag metadata
        id: release_meta
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require("child_process");
            const semverPattern = /^v(\d+)\.(\d+)\.(\d+)$/;

            const readTags = (command) => {
              const output = execSync(command, { encoding: "utf8" }).trim();
              return output ? output.split("\n").filter(Boolean) : [];
            };

            const allTags = readTags("git tag --list 'v*' --sort=-v:refname");
            const headTags = readTags("git tag --points-at HEAD --list 'v*' --sort=-v:refname");

            let nextTag = "";
            let previousTag = "";

            if (headTags.length > 0) {
              nextTag = headTags[0];
              if (!semverPattern.test(nextTag)) {
                core.setFailed(`Tag on HEAD has invalid semver format: ${nextTag}`);
                return;
              }

              previousTag = allTags.find((tag) => tag !== nextTag) || "";
            } else if (allTags.length === 0) {
              nextTag = "v0.1.0";
            } else {
              const latestTag = allTags[0];
              const match = latestTag.match(semverPattern);

              if (!match) {
                core.setFailed(`Latest release tag has invalid semver format: ${latestTag}`);
                return;
              }

              const major = Number(match[1]);
              const minor = Number(match[2]);
              const patch = Number(match[3]) + 1;

              nextTag = `v${major}.${minor}.${patch}`;
              previousTag = latestTag;
            }

            core.info(`Using release tag: ${nextTag}`);
            core.setOutput("tag", nextTag);
            core.setOutput("previous_tag", previousTag);

      - name: Package plugin release archives
        env:
          RELEASE_TAG: ${{ steps.release_meta.outputs.tag }}
        run: |
          set -euo pipefail

          PLUGINS_DIR=".tmp/plugins"
          OUTPUT_DIR=".tmp/release-assets"
          AGENTS=(claudecode copilot geminicli opencode codexcli antigravity)

          rm -rf "$OUTPUT_DIR"
          mkdir -p "$OUTPUT_DIR"

          for agent in "${AGENTS[@]}"; do
            if [[ ! -d "$PLUGINS_DIR/$agent" ]]; then
              echo "Missing plugin directory: $PLUGINS_DIR/$agent" >&2
              exit 1
            fi

            tar -czf "$OUTPUT_DIR/dotnet-agent-harness-${agent}-${RELEASE_TAG}.tar.gz" -C "$PLUGINS_DIR" "$agent"
            (
              cd "$PLUGINS_DIR"
              zip -rq "$GITHUB_WORKSPACE/$OUTPUT_DIR/dotnet-agent-harness-${agent}-${RELEASE_TAG}.zip" "$agent"
            )
          done

      - name: Package rulesync source archive
        env:
          RELEASE_TAG: ${{ steps.release_meta.outputs.tag }}
        run: |
          set -euo pipefail

          OUTPUT_DIR=".tmp/release-assets"
          RULESYNC_SOURCE_DIR=".tmp/rulesync-source"

          if [[ ! -d ".rulesync" ]]; then
            echo "Missing rulesync directory: .rulesync" >&2
            exit 1
          fi

          if [[ ! -f "rulesync.jsonc" ]]; then
            echo "Missing rulesync config file: rulesync.jsonc" >&2
            exit 1
          fi

          rm -rf "$RULESYNC_SOURCE_DIR"
          mkdir -p "$RULESYNC_SOURCE_DIR"

          cp -R .rulesync "$RULESYNC_SOURCE_DIR/.rulesync"
          cp rulesync.jsonc "$RULESYNC_SOURCE_DIR/rulesync.jsonc"

          tar -czf "$OUTPUT_DIR/dotnet-agent-harness-rulesync-${RELEASE_TAG}.tar.gz" -C "$RULESYNC_SOURCE_DIR" .
          (
            cd "$RULESYNC_SOURCE_DIR"
            zip -rq "$GITHUB_WORKSPACE/$OUTPUT_DIR/dotnet-agent-harness-rulesync-${RELEASE_TAG}.zip" .
          )

      - name: Generate checksums file
        env:
          RELEASE_TAG: ${{ steps.release_meta.outputs.tag }}
        run: |
          set -euo pipefail

          OUTPUT_DIR=".tmp/release-assets"
          (
            cd "$OUTPUT_DIR"
            sha256sum ./*.tar.gz ./*.zip > "checksums-${RELEASE_TAG}.txt"
          )

      - name: Generate scoped release notes
        env:
          RELEASE_TAG: ${{ steps.release_meta.outputs.tag }}
          PREVIOUS_TAG: ${{ steps.release_meta.outputs.previous_tag }}
        run: |
          set -euo pipefail

          NOTES_FILE=".tmp/release-assets/release-notes.md"
          AGENTS=(claudecode copilot geminicli opencode codexcli antigravity)

          scope_logs() {
            local scope_title="$1"
            shift
            local -a scope_paths=("$@")
            local logs=""

            if [[ -n "$PREVIOUS_TAG" ]]; then
              logs="$(git log --no-merges --pretty='- %h %s' "${PREVIOUS_TAG}..HEAD" -- "${scope_paths[@]}" || true)"
            else
              logs="$(git log --no-merges --pretty='- %h %s' -- "${scope_paths[@]}" || true)"
            fi

            {
              printf '## %s\n' "$scope_title"
              if [[ -n "$logs" ]]; then
                printf '%s\n' "$logs"
              else
                printf '%s\n' "- No changes in this release."
              fi
              printf '\n'
            } >> "$NOTES_FILE"
          }

          {
            printf '# %s\n\n' "$RELEASE_TAG"
            if [[ -n "$PREVIOUS_TAG" ]]; then
              printf '_Changes since %s._\n\n' "$PREVIOUS_TAG"
            else
              printf '_Initial release._\n\n'
            fi
          } > "$NOTES_FILE"

          scope_logs "rulesync" ".rulesync" "rulesync.jsonc" "scripts/build/build_plugin_bundles.sh" "scripts/ci/validate_rulesync.sh"
          for agent in "${AGENTS[@]}"; do
            scope_logs "$agent" "plugins/$agent"
          done

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.release_meta.outputs.tag }}
          body_path: .tmp/release-assets/release-notes.md
          files: |
            .tmp/release-assets/*.tar.gz
            .tmp/release-assets/*.zip
            .tmp/release-assets/checksums-*.txt
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.DOTNET_HARNESS_TOOLKIT_GH_TOKEN || github.token }}
